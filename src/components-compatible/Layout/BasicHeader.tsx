import React, { useState } from 'react';
import { useDispatch, useHistory, useSelector, FormattedMessage } from 'umi';
import { Badge, Modal } from 'antd';
import { BasicAppMenu } from './BasicAppMenu';
import BellPop from '../Bell/BellPop';
import { IconTasks, IconSignOut } from '@/components-compatible/Icons';

export default function BasicHeader(props: any) {
  const { route } = props;
  const dispatch = useDispatch<any>();
  const history = useHistory();

  const [bellPopVisible, ChangeBellPopVisible] = useState<boolean>(false);
  const currentUser = 'admin'; //   从localStorage中获取当前用户

  const BellCount = useSelector(
    (state: any) => state.createrate.createObjIds.length,
  );

  function handleLogout() {
    Modal.confirm({
      title: (
        <FormattedMessage
          id="dashboard.header.logout"
          defaultMessage="您确认退出吗？"
        />
      ),
      cancelText: (
        <FormattedMessage id="common.modalcancel" defaultMessage="取消" />
      ),
      okText: <FormattedMessage id="common.modalok" defaultMessage="确定" />,
      okType: 'danger',
      onOk: () => {
        dispatch({
          type: 'account/Logout',
        }).then((result: boolean) => {
          if (result) {
            history.push('/login');
          }
        });
      },
    });
  }

  function handleBellPop() {
    ChangeBellPopVisible(!bellPopVisible);
  }

  function closeBellPop() {
    ChangeBellPopVisible(false);
  }

  return (
    <>
      <div className="ami-brand">
        {/* <FormattedMessage id="common.ProductName" defaultMessage="安全实例管理平台" /> */}
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="118"
          height="28"
          viewBox="0 0 118 28"
        >
          <path
            fill="#2672f4"
            d="M14.461,7.331L21.151,14l-6.689,6.669L7.772,14Z"
          />
          <path fill="#2672f4" d="M-0.167,7.748L6.1,14l-6.271,6.252V7.748Z" />
          <path
            fill="#2672f4"
            opacity="0.6"
            d="M6.52-.169l6.271,6.252L6.52,12.335v-12.5Z"
          />
          <path
            fill="#2672f4"
            opacity="0.6"
            d="M6.52,15.665l6.271,6.252L6.52,28.169v-12.5Z"
          />
          <path
            fill="#36383c"
            d="M32.669,6.444A4.926,4.926,0,0,0,31.4,10.008V22.2h3.288V13.352h4.061V10.624H34.688V10.052a3.521,3.521,0,0,1,.1-0.858,1.739,1.739,0,0,1,.331-0.682,1.549,1.549,0,0,1,.64-0.451,2.687,2.687,0,0,1,1-.165,5.743,5.743,0,0,1,.872.066,3.156,3.156,0,0,1,.783.22l0.574-2.574a7.418,7.418,0,0,0-1.026-.33,6.389,6.389,0,0,0-1.534-.154A4.985,4.985,0,0,0,32.669,6.444Zm11.266,4.18H40.647V22.2h3.288V10.624ZM43.659,5.861a2.1,2.1,0,0,0-2.759,0,1.8,1.8,0,0,0-.585,1.419A1.8,1.8,0,0,0,40.9,8.7a2.1,2.1,0,0,0,2.759,0,1.8,1.8,0,0,0,.585-1.419A1.8,1.8,0,0,0,43.659,5.861Zm4.4,13.794a10.788,10.788,0,0,1-1.721-.517L45.788,21.8a10.422,10.422,0,0,0,1.423.44,10.527,10.527,0,0,0,2.571.264,6.455,6.455,0,0,0,3.652-.878,2.931,2.931,0,0,0,1.291-2.591,4.422,4.422,0,0,0-.166-1.273,2.589,2.589,0,0,0-.574-1,4.274,4.274,0,0,0-1.114-.838,13.52,13.52,0,0,0-1.788-.787q-0.53-.2-0.872-0.366a3.723,3.723,0,0,1-.541-0.309,0.751,0.751,0,0,1-.265-0.3,0.882,0.882,0,0,1-.066-0.352q0-.858,1.545-0.858a6.81,6.81,0,0,1,1.512.154,12.146,12.146,0,0,1,1.247.352l0.574-2.552a9.5,9.5,0,0,0-1.545-.407,10.734,10.734,0,0,0-2.03-.187,5.292,5.292,0,0,0-3.332.946A3.088,3.088,0,0,0,46.1,13.836a3.773,3.773,0,0,0,.243,1.43,2.975,2.975,0,0,0,.684,1.023,4.116,4.116,0,0,0,1.07.737,15.066,15.066,0,0,0,1.4.594,9.259,9.259,0,0,1,1.479.671,0.836,0.836,0,0,1,.486.693,0.68,0.68,0,0,1-.375.682,3.29,3.29,0,0,1-1.28.176A8.391,8.391,0,0,1,48.061,19.655ZM59.911,22.2V13.4q0.309-.088.7-0.165a4.229,4.229,0,0,1,.828-0.077,1.634,1.634,0,0,1,1.512.66,4.511,4.511,0,0,1,.408,2.244V22.2h3.288V15.662a9.273,9.273,0,0,0-.232-2.156,4.206,4.206,0,0,0-.794-1.672,3.65,3.65,0,0,0-1.5-1.089,6.228,6.228,0,0,0-2.35-.385,5.349,5.349,0,0,0-1,.1,6.834,6.834,0,0,0-.85.209V5.124l-3.288.528V22.2h3.288Zm14.256-2.552a3.891,3.891,0,0,1-1-.132,2.859,2.859,0,0,1-.805-0.33V13.264q0.243-.044.618-0.077t0.817-.033a2.377,2.377,0,0,1,2.03.913,3.959,3.959,0,0,1,.684,2.431q0,3.146-2.339,3.146h0ZM79.452,13.9A5.19,5.19,0,0,0,78.272,12a5.267,5.267,0,0,0-1.9-1.21,7.149,7.149,0,0,0-2.56-.429q-0.6,0-1.247.055t-1.28.143q-0.629.088-1.2,0.209t-1.015.253V26.266h3.288V21.91a6.157,6.157,0,0,0,1.147.374,5.91,5.91,0,0,0,1.28.132,5.143,5.143,0,0,0,2.185-.44,4.385,4.385,0,0,0,1.589-1.232,5.49,5.49,0,0,0,.971-1.892,8.457,8.457,0,0,0,.331-2.442A7.3,7.3,0,0,0,79.452,13.9Zm12.832,0a5.593,5.593,0,0,0-1.17-1.914,5.242,5.242,0,0,0-1.8-1.232,5.9,5.9,0,0,0-2.306-.44,5.841,5.841,0,0,0-2.284.44,5.355,5.355,0,0,0-1.81,1.232A5.635,5.635,0,0,0,81.725,13.9a6.891,6.891,0,0,0-.43,2.486,7.143,7.143,0,0,0,.419,2.5,5.681,5.681,0,0,0,1.17,1.936,5.159,5.159,0,0,0,1.8,1.243,5.96,5.96,0,0,0,2.328.44,6.021,6.021,0,0,0,2.35-.44,5.165,5.165,0,0,0,1.8-1.243,5.424,5.424,0,0,0,1.148-1.936,7.5,7.5,0,0,0,.4-2.5A7.059,7.059,0,0,0,92.285,13.9Zm-3.542,4.9a1.972,1.972,0,0,1-1.732.891,2,2,0,0,1-1.743-.891,4.161,4.161,0,0,1-.618-2.409A4.055,4.055,0,0,1,85.267,14a2.014,2.014,0,0,1,1.743-.869A1.987,1.987,0,0,1,88.743,14a4.112,4.112,0,0,1,.607,2.387A4.22,4.22,0,0,1,88.743,18.8Zm5.947,3.4h3.288V13.264q0.309-.044.706-0.077t0.75-.033a1.712,1.712,0,0,1,1.567.66,4.4,4.4,0,0,1,.42,2.244V22.2h3.288V15.662a8.862,8.862,0,0,0-.243-2.156,4.236,4.236,0,0,0-.817-1.672,3.7,3.7,0,0,0-1.555-1.089,6.8,6.8,0,0,0-2.461-.385,17.828,17.828,0,0,0-2.78.209,18.417,18.417,0,0,0-2.163.451V22.2Zm17.588-9.042a3.894,3.894,0,0,1,1,.132,2.859,2.859,0,0,1,.805.33v5.962q-0.243.044-.618,0.077t-0.816.033a2.363,2.363,0,0,1-2.03-.924,4,4,0,0,1-.685-2.442q0-3.168,2.34-3.168h0Zm5.1-8.03-3.288.528v5.236A6.663,6.663,0,0,0,113,10.514a5.185,5.185,0,0,0-1.225-.132,5.456,5.456,0,0,0-2.2.418,4.349,4.349,0,0,0-1.622,1.21,5.524,5.524,0,0,0-1.015,1.925,8.537,8.537,0,0,0-.353,2.541,7.2,7.2,0,0,0,.408,2.5,5.022,5.022,0,0,0,3.079,3.091,7.321,7.321,0,0,0,2.56.418q0.6,0,1.247-.055t1.28-.143q0.628-.088,1.2-0.209t1.015-.253V5.124Z"
          />
        </svg>
      </div>
      {/* 通过currentAuthority来控制展示的组件 */}
      {currentUser === 'admin' ? (
        <BasicAppMenu route={route} currentAuthority={'admin'} />
      ) : (
        <BasicAppMenu route={route} currentAuthority={'user'} />
      )}
      <div className="ami-toolbar space-sm">
        <button
          className="btn btn-icon btn-icon-lg btn-transparent"
          onClick={handleBellPop}
        >
          <Badge count={BellCount} size="small">
            <IconTasks />
          </Badge>
        </button>
        <button className="btn btn-icon btn-transparent" onClick={handleLogout}>
          <IconSignOut />
        </button>
      </div>
      <BellPop visible={bellPopVisible} onCancel={closeBellPop} />
    </>
  );
}
